<!DOCTYPE html>
<html>
<head>
  <title>SEO Off-Page Analyzer</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; margin-top: 15px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #eee; }

    .Tier\ 1 { background: #c4f7c8; }
    .Tier\ 2 { background: #fff8bc; }
    .Tier\ 3 { background: #ffd5d5; }
    .Blocked { background: #e0e0e0; }

    .controls > * { margin-right: 10px; }
  </style>
</head>

<body>

<h2>SEO Off-Page Analyzer</h2>

<form id="uploadForm">
  <input type="file" id="fileInput" accept=".csv,.xlsx" required>
  <button type="submit">Analyze</button>
</form>

<div id="progressBox" hidden>
  Progress: <span id="progressText"></span>
</div>

<div class="controls" hidden id="filterBox">
  <select id="f_niche"></select>
  <select id="f_cms"></select>
  <select id="f_tier"></select>
  <select id="f_spam"></select>
  <select id="f_group"></select>
</div>

<table id="resultsTable" hidden>
  <thead>
    <tr>
      <th>URL</th>
      <th>Niche</th>
      <th>CMS</th>
      <th>Submission</th>
      <th>Guest?</th>
      <th>Spam</th>
      <th>Authority</th>
      <th>Tier</th>
      <th>Group</th>
      <th>Load Time</th>
      <th>Length</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const form = document.getElementById("uploadForm");
const fileInput = document.getElementById("fileInput");
const progressBox = document.getElementById("progressBox");
const progressText = document.getElementById("progressText");
const resultTable = document.getElementById("resultsTable");
const tbody = resultTable.querySelector("tbody");
const filterBox = document.getElementById("filterBox");

const f_niche = document.getElementById("f_niche");
const f_cms = document.getElementById("f_cms");
const f_tier = document.getElementById("f_tier");
const f_spam = document.getElementById("f_spam");
const f_group = document.getElementById("f_group");

let run_id = null;
let allResults = [];

// ------------------ Upload Handler --------------------
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const fd = new FormData();
  fd.append("file", fileInput.files[0]);

  const res = await fetch("/api/analyze", { method: "POST", body: fd });
  const data = await res.json();
  run_id = data.run_id;

  progressBox.hidden = false;
  progressText.textContent = "0%";

  pollProgress();
});

async function pollProgress() {
  const res = await fetch(`/api/progress/${run_id}`);
  const data = await res.json();

  const percent = Math.floor((data.completed / data.total) * 100);
  progressText.textContent = percent + "%";

  if (data.completed < data.total) {
    setTimeout(pollProgress, 1200);
  } else {
    loadResults();
  }
}

async function loadResults() {
  const res = await fetch(`/api/results/${run_id}`);
  allResults = await res.json();

  renderFilters();
  renderTable();
  resultTable.hidden = false;
  filterBox.hidden = false;
}

// ------------------ Filters -------------------------

function renderFilters() {
  renderSelect(f_niche, "niche");
  renderSelect(f_cms, "cms");
  renderSelect(f_tier, "quality_tier");
  renderSelect(f_spam, "spam_risk");
  renderSelect(f_group, "structure_group");
}

function renderSelect(el, field) {
  const unique = [...new Set(allResults.map(r => r[field]))];
  el.innerHTML = `<option value="ALL">${field.toUpperCase()}</option>`;
  unique.forEach(u => {
    el.innerHTML += `<option value="${u}">${u}</option>`;
  });

  el.onchange = renderTable;
}

// ------------------ Table Render --------------------

function renderTable() {
  const n = f_niche.value;
  const c = f_cms.value;
  const t = f_tier.value;
  const s = f_spam.value;
  const g = f_group.value;

  tbody.innerHTML = "";

  allResults
    .filter(r =>
      (n === "ALL" || r.niche === n) &&
      (c === "ALL" || r.cms === c) &&
      (t === "ALL" || r.quality_tier === t) &&
      (s === "ALL" || r.spam_risk === s) &&
      (g === "ALL" || r.structure_group === g)
    )
    .forEach(r => {
      const tr = document.createElement("tr");
      tr.className = r.quality_tier;

      tr.innerHTML = `
        <td>${r.url}</td>
        <td>${r.niche}</td>
        <td>${r.cms}</td>
        <td>${r.submission_type}</td>
        <td>${r.guest_post ? "Yes" : "No"}</td>
        <td>${r.spam_risk}</td>
        <td>${r.authority_score}</td>
        <td>${r.quality_tier}</td>
        <td>${r.structure_group}</td>
        <td>${r.load_time.toFixed(2)}s</td>
        <td>${r.content_length}</td>
      `;

      tbody.appendChild(tr);
    });
}
</script>

</body>
</html>
